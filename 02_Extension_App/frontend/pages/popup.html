<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Privacy Score</title>

  <!-- Link to external CSS -->
  <link rel="stylesheet" href="../styles/popup.css">
</head>

<body class="font-display text-white antialiased">
  <div class="card-container">
    <!-- Card uses your navyâ†’deep-navy gradient, with neon accents -->
    <div class="card space-y-6">

      <!-- Donut -->
      <div class="relative w-48 h-48 mx-auto">
        <svg class="w-full h-full" viewBox="0 0 100 100" aria-label="Privacy Score">
          <!-- track -->
          <circle cx="50" cy="50" r="45" fill="transparent"
                  class="text-white-10" stroke="currentColor" stroke-width="10"></circle>
          <!-- progress -->
          <circle cx="50" cy="50" r="45" fill="transparent"
                  class="progress-ring__circle" stroke-linecap="round" stroke-width="10"></circle>
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center">
          <span id="scoreValue" class="text-5xl font-extrabold text-primary">0</span>
          <span class="text-sm font-medium text-white-60">Privacy Score</span>
        </div>
      </div>

      <!-- Copy -->
      <div class="text-center">
        <h2 id="scoreMessage" class="text-xl font-bold">Analyzing your privacy...</h2>
        <p class="mt-1 text-sm text-white-60">Please wait while we calculate your score.</p>
      </div>

      <!-- Actions -->
      <div class="flex flex-col gap-3 pt-2">
        <button id="goPrivateBtn" class="w-full h-12 px-6 text-base font-bold rounded-lg">
          Go Private
        </button>
        <button id="detailsBtn" class="w-full h-12 px-6 text-base font-bold rounded-lg">
          Details
        </button>
      </div>
    </div>
  </div>

  <!-- Link to external JavaScript -->
  <script src="../scripts/popup.js"></script>
  
  <!-- Button Handlers for popup.html (pages folder context) -->
  <script>
    (function() {
      'use strict';
      
      console.log('[popup.html] Initializing button handlers...');
      
      document.addEventListener('DOMContentLoaded', function() {
        
        // ====== Details Button - Opens Dashboard ======
        const detailsBtn = document.getElementById('detailsBtn');
        if (detailsBtn && !detailsBtn.hasAttribute('data-handler-attached')) {
          detailsBtn.setAttribute('data-handler-attached', 'true');
          detailsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('[popup.html] Details button clicked');
            
            // Check if we're in extension context
            if (typeof chrome !== 'undefined' && chrome.tabs) {
              // Extension context - open in new tab
              const dashboardUrl = chrome.runtime.getURL('frontend/pages/dashboard.html');
              console.log('[popup.html] Opening dashboard via chrome.tabs:', dashboardUrl);
              chrome.tabs.create({ url: dashboardUrl });
            } else {
              // Regular web context - navigate normally
              console.log('[popup.html] Navigating to dashboard.html');
              window.location.href = 'dashboard.html';
            }
          });
          console.log('[popup.html] Details button handler attached');
        }
        
        // ====== Go Private Button - Activates Privacy Mode ======
        const goPrivateBtn = document.getElementById('goPrivateBtn');
        if (goPrivateBtn && !goPrivateBtn.hasAttribute('data-handler-attached')) {
          goPrivateBtn.setAttribute('data-handler-attached', 'true');
          goPrivateBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            console.log('[popup.html] Go Private button clicked');
            
            try {
              // Visual feedback
              const originalText = goPrivateBtn.textContent;
              goPrivateBtn.textContent = 'Activating...';
              goPrivateBtn.disabled = true;
              
              // Check if we're in extension context
              if (typeof chrome !== 'undefined' && chrome.runtime) {
                // Send message to service worker
                chrome.runtime.sendMessage({ action: 'activatePrivacy' }, function(response) {
                  if (chrome.runtime.lastError) {
                    console.warn('[popup.html] Service worker error:', chrome.runtime.lastError);
                    applyPrivacySettingsFallback();
                  } else {
                    console.log('[popup.html] Privacy mode activated:', response);
                  }
                  
                  // Update button
                  goPrivateBtn.textContent = 'Privacy Active!';
                  goPrivateBtn.classList.add('opacity-75');
                  
                  // Reset after delay
                  setTimeout(() => {
                    goPrivateBtn.textContent = originalText;
                    goPrivateBtn.disabled = false;
                    goPrivateBtn.classList.remove('opacity-75');
                  }, 2000);
                });
              } else {
                // Fallback for non-extension context
                console.log('[popup.html] Non-extension context, using fallback');
                applyPrivacySettingsFallback();
                
                goPrivateBtn.textContent = 'Privacy Active!';
                setTimeout(() => {
                  goPrivateBtn.textContent = originalText;
                  goPrivateBtn.disabled = false;
                }, 2000);
              }
              
            } catch (error) {
              console.error('[popup.html] Error activating privacy mode:', error);
              goPrivateBtn.textContent = 'Try Again';
              goPrivateBtn.disabled = false;
            }
          });
          console.log('[popup.html] Go Private button handler attached');
        }
        
        // ====== Helper Functions ======
        function applyPrivacySettingsFallback() {
          console.log('[popup.html] Applying privacy settings (fallback)...');
          
          if (typeof chrome !== 'undefined' && chrome.storage) {
            chrome.storage.local.set({ privacyScore: 90, privacyModeActive: true }, function() {
              console.log('[popup.html] Privacy score updated to 90');
              
              // Update UI if animateScore is available
              if (typeof animateScore === 'function') {
                animateScore(90);
              }
            });
          }
        }
        
        console.log('[popup.html] All handlers initialized');
      });
      
    })();
  </script>
</body>
</html>
